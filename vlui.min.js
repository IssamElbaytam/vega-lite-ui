"use strict";function getNameMap(t){return t.reduce(function(t,e){return t[e.name]=e,t},{})}angular.module("vlui",["LocalStorageModule","angular-websql"]).constant("_",window._).constant("vl",window.vl).constant("vg",window.vg).constant("Papa",window.Papa).constant("dl",window.dl).constant("Blob",window.Blob).constant("URL",window.URL).constant("consts",{addCount:!0,debug:!0,useUrl:!0,logging:!1,defaultConfigSet:"large",appId:"polestar"}),angular.module("vlui").service("Alerts",function(t,e){var a={};return a.alerts=[],a.add=function(n,i){var r={msg:n};a.alerts.push(r),i&&t(function(){var t=e.findIndex(a.alerts,r);a.closeAlert(t)},i)},a.closeAlert=function(t){a.alerts.splice(t,1)},a}),angular.module("vlui").service("Bookmarks",function(t,e,a,n){var i=function(){this.dict={},this.length=0},r=i.prototype;return r.updateLength=function(){this.length=Object.keys(this.dict).length},r.save=function(){a.set("bookmarks",this.dict)},r.load=function(){this.dict=a.get("bookmarks")||{},this.updateLength()},r.clear=function(){this.dict={},this.updateLength(),this.save(),n.logInteraction(n.actions.BOOKMARKS_CLEAR)},r.toggle=function(t){var e=t.shorthand;this.dict[e]?this.remove(t):this.add(t)},r.add=function(e){var a=e.shorthand;console.log("adding",e.vlSpec,a),e.timeAdded=(new Date).getTime(),this.dict[a]=t.cloneDeep(e),this.updateLength(),this.save(),n.logInteraction(n.actions.BOOKMARK_ADD,a)},r.remove=function(t){var e=t.shorthand;console.log("removing",t.vlSpec,e),delete this.dict[e],this.updateLength(),this.save(),n.logInteraction(n.actions.BOOKMARK_REMOVE,e)},r.isBookmarked=function(t){return t in this.dict},new i});var datasets=[{name:"Barley",url:"data/barley.json",id:"barley"},{name:"Cars",url:"data/cars.json",id:"cars"},{name:"Crimea",url:"data/crimea.json",id:"crimea"},{name:"Driving",url:"data/driving.json",id:"driving"},{name:"Iris",url:"data/iris.json",id:"iris"},{name:"Jobs",url:"data/jobs.json",id:"jobs"},{name:"Population",url:"data/population.json",id:"population"},{name:"Movies",url:"data/movies.json",id:"movies"},{name:"Birdstrikes",url:"data/birdstrikes.json",id:"birdstrikes"},{name:"Burtin",url:"data/burtin.json",id:"burtin"},{name:"Budget 2016",url:"data/budget.json",id:"budget"},{name:"Climate Normals",url:"data/climate.json",id:"climate"},{name:"Campaigns",url:"data/weball26.json",id:"weball26"}];angular.module("vlui").factory("Dataset",function(t,e,a,n,i,r){var s={};return s.datasets=datasets,s.dataset=datasets[1],s.dataschema=[],s.dataschema.byName={},s.stats={},s.type=void 0,s.typeNames={O:"text",Q:"number",T:"time",G:"geo"},s.fieldOrder=r.field.order.typeThenName,s.getSchema=function(t,e,n){var s=i.read.types(t),o=a.reduce(s,function(t,e,a){return t.push({name:a,type:r.data.types[e]}),t},[]);return o=i.stablesort(o,n||r.field.order.typeThenName,r.field.order.name),o.push(r.field.count()),o.forEach(function(t){var a=e[t.name];void 0!==a&&"Q"===t.type&&a.distinct<=20&&(a.distinct<(a.count-a.numNulls)/50||a.distinct<=7)&&(t.type="O")}),o},s.getStats=function(t){var e=i.summary(t);return e.reduce(function(t,e){return t[e.field]=e,t},{count:t.length})},s.update=function(i){return t.get(i.url,{cache:!0}).then(function(t){if(a.isObject(t.data))s.data=t.data,s.type="json";else{var i=n.parse(t.data,{dynamicTyping:!0,header:!0});if(0!==i.errors.length)return a.each(i.errors,function(t){e.add(t.message,2e3)}),void 0;s.data=i.data,s.type="csv"}s.stats=s.getStats(s.data),s.dataschema=s.getSchema(s.data,s.stats),s.dataschema.byName=getNameMap(s.dataschema)})},s.add=function(t){t.id||(t.id=t.url),datasets.push(t)},s}),angular.module("vlui").service("Logger",function(t,e,a,n,i,r,s){var o={},d=t.search().user;return o.db=a.openDatabase("logs","1.0","Logs",2097152),o.tableName="log_"+n.appId,o.actions={UNDO:"UNDO",REDO:"REDO",DATASET_CHANGE:"DATASET_CHANGE",CHART_MOUSEOVER:"CHART_MOUSEOVER",CHART_MOUSEOUT:"CHART_MOUSEOUT",CHART_RENDER:"CHART_RENDER",CHART_EXPOSE:"CHART_EXPOSE",CHART_TOOLTIP:"CHART_TOOLTIP",BOOKMARK_ADD:"BOOKMARK_ADD",BOOKMARK_REMOVE:"BOOKMARK_REMOVE",BOOKMARKS_CLEAR:"BOOKMARKS_CLEAR",NULL_FILTER_TOGGLE:"NULL_FILTER_TOGGLE",TRANSPOSE_TOGGLE:"TRANSPOSE_TOGGLE",SORT_TOGGLE:"SORT_TOGGLE",MARKTYPE_TOGGLE:"MARKTYPE_TOGGLE",LOG_TOGGLE:"LOG_TOGGLE",FUNC_CHANGE:"FUNC_CHANGE",SPEC_CHANGE:"SPEC_CHANGE",FIELD_DROP:"FIELD_DROP",MARK_CHANGE:"MARK_CHANGE",FIELDS_CHANGE:"FIELDS_CHANGE",FIELDS_RESET:"FIELDS_RESET",DRILL_DOWN_OPEN:"DRILL_DOWN_OPEN",DRILL_DOWN_CLOSE:"DRILL_DOWN_CLOSE",CLUSTER_SELECT:"CLUSTER_SELECT",LOAD_MORE:"LOAD_MORE"},o.createTableIfNotExists=function(){o.db.createTable(o.tableName,{userid:{type:"INTEGER","null":"NOT NULL"},time:{type:"TIMESTAMP","null":"NOT NULL","default":"CURRENT_TIMESTAMP"},action:{type:"TEXT","null":"NOT NULL"},data:{type:"TEXT"},diff:{type:"TEXT"}})},o.clear=function(){var t=e.confirm("Really clear the logs?");t===!0&&(o.db.dropTable(o.tableName),o.createTableIfNotExists())},o.export=function(){o.db.selectAll(o.tableName).then(function(t){if(0===t.rows.length)return console.warn("No logs"),void 0;for(var e=[],a=0;a<t.rows.length;a++)e.push(t.rows.item(a));var n=i.unparse(e),d=new r([n],{type:"text/csv"}),l=s.createObjectURL(d),u=angular.element("<a/>");u.attr({href:l,target:"_blank",download:o.tableName+".csv"})[0].click()})},o.logInteraction=function(t,e,a){if(n.logging){var i={userid:d,action:t};void 0!==e&&(i.data=JSON.stringify(e)),void 0!==a&&(i.diff=JSON.stringify(a)),o.db.insert(o.tableName,i).then(function(){})}},o.createTableIfNotExists(),o});